name: Generate OpenAPI Docs and Create PR to Another Repo with Auto-Merge

on:
  push:
    branches:
      - master

jobs:
  generate-and-create-pr:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------
      # 1. ソースコードのチェックアウトとドキュメント生成 (変更なし)
      # -----------------------------------------------------
      - name: Checkout Source Repository
        uses: actions/checkout@v4
        with:
          path: source-repo

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Generate OpenAPI docs
        working-directory: ./source-repo
        run: ./gradlew generateOpenApiDocs

      # -----------------------------------------------------
      # 2. 宛先リポジトリのチェックアウトとファイルコピー (変更なし)
      # -----------------------------------------------------
      - name: Checkout Destination Repository
        uses: actions/checkout@v4
        with:
          repository: KasumiMercury/todo-server-poc-schema  # <<< PRを作成したいリポジトリ
          path: destination-repo
          token: ${{ secrets.DOCS_REPO_PAT }} # <<< 事前準備で作成したPAT

      - name: Copy generated file
        run: |
          cp ./source-repo/build/openapi.json ./destination-repo/user-server.json

      # -----------------------------------------------------
      # 3. Pull Requestの作成と自動マージの設定
      # -----------------------------------------------------
      - name: Create Pull Request
        id: cpr # <<< ステップにIDを設定
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DOCS_REPO_PAT }}
          path: ./destination-repo
          commit-message: "docs: Update OpenAPI specification"
          branch: "feature/update-openapi-spec"
          delete-branch: true
          base: main
          title: '[Automated] Update OpenAPI Specification'
          body: |
            Source repositoryのmasterブランチへのpushをトリガーにOpenAPIの仕様書を更新しました。

            **Source Commit:** `${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}`

            ---
            *This Pull Request was generated automatically by a GitHub Action.*

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-number != '' # <<< PRが作成された場合のみ実行
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.DOCS_REPO_PAT }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash # マージ方法を指定 (squash | merge | rebase)